name: Auto-merge codex-trivial PRs
on:
  workflow_dispatch: {}
  pull_request:
    types: [labeled, synchronize]

jobs:
  automerge:
    if: contains(github.event.pull_request.labels.*.name, 'codex-trivial')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;
            // check combined status
            const checks = await github.rest.checks.listForRef({ owner, repo, ref: pr.head.sha });
            const allPassed = checks.data.check_runs.every(r => r.conclusion === 'success' || r.conclusion === 'skipped' || r.conclusion === 'neutral');
            if (!allPassed) {
              core.setOutput('status', 'checks not all successful');
              return;
            }
            await github.rest.pulls.merge({ owner, repo, pull_number: pr.number, merge_method: 'merge' });
            core.setOutput('status', 'merged');
